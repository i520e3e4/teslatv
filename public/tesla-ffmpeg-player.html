<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>TeslaTV FFmpeg Player</title>
    <meta name="tesla-theater" content="true">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #player-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video-canvas {
            max-width: 100%;
            max-height: 100%;
            background: #000;
        }

        /* æ§åˆ¶å±‚ */
        #controls-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            opacity: 1;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        #controls-overlay.hidden {
            opacity: 0;
        }

        #controls-overlay>* {
            pointer-events: auto;
        }

        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px 30px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .video-title {
            color: #fff;
            font-size: 22px;
            font-weight: 600;
            max-width: 50%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tesla-badge {
            background: linear-gradient(135deg, #46d369, #2ecc71);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .exit-btn {
            background: rgba(229, 9, 20, 0.9);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .center-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 40px;
        }

        .ctrl-circle {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: #fff;
        }

        .ctrl-circle.play-btn {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(70, 211, 105, 0.95), rgba(46, 204, 113, 0.9));
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 60px rgba(70, 211, 105, 0.5);
        }

        .bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 30px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #46d369, #2ecc71);
            border-radius: 4px;
            width: 0%;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-display {
            color: #fff;
            font-size: 16px;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
        }

        .ctrl-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #46d369;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #fff;
            margin-top: 20px;
            font-size: 18px;
            text-align: center;
        }

        .loading-progress {
            color: #888;
            margin-top: 10px;
            font-size: 14px;
        }

        .progress-bar-loading {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #46d369;
            width: 0%;
            transition: width 0.3s ease;
        }

        .mode-indicator {
            position: fixed;
            bottom: 120px;
            right: 30px;
            background: rgba(0, 0, 0, 0.7);
            color: #46d369;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 50;
        }

        .mode-dot {
            width: 8px;
            height: 8px;
            background: #46d369;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .error-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .error-overlay.show {
            display: flex;
        }

        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .error-text {
            color: #fff;
            font-size: 20px;
            margin-bottom: 30px;
        }

        .retry-btn {
            background: #46d369;
            color: #fff;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        /* å®‰å…¨è­¦å‘Š */
        .safety-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            text-align: center;
        }

        .safety-warning.hidden {
            display: none;
        }

        .warning-icon {
            font-size: 80px;
            margin-bottom: 30px;
        }

        .warning-title {
            color: #ff6b6b;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .warning-text {
            color: #ccc;
            font-size: 18px;
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 40px;
        }

        .passenger-btn {
            background: linear-gradient(135deg, #46d369, #2ecc71);
            color: #fff;
            border: none;
            padding: 20px 60px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- å®‰å…¨è­¦å‘Š -->
    <div class="safety-warning" id="safetyWarning">
        <div class="warning-icon">âš ï¸</div>
        <div class="warning-title">å®‰å…¨æç¤º</div>
        <div class="warning-text">
            è¡Œè½¦æ—¶è¯·ä¸“æ³¨é©¾é©¶ã€‚<br>
            å¦‚æœæ‚¨æ˜¯ä¹˜å®¢ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ’­æ”¾ã€‚<br>
            é¦–æ¬¡åŠ è½½éœ€è¦çº¦ 40-60 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚
        </div>
        <button class="passenger-btn" onclick="acceptWarning()">æˆ‘æ˜¯ä¹˜å®¢ï¼Œå¼€å§‹æ’­æ”¾</button>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="loading-overlay hidden" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">æ­£åœ¨åˆå§‹åŒ– FFmpeg...</div>
        <div class="loading-progress" id="loading-progress"></div>
        <div class="progress-bar-loading">
            <div class="progress-bar-fill" id="progressBarFill"></div>
        </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div class="error-overlay" id="error">
        <div class="error-icon">âŒ</div>
        <div class="error-text" id="error-text">è§†é¢‘åŠ è½½å¤±è´¥</div>
        <button class="retry-btn" onclick="retryPlay()">é‡è¯•</button>
        <button class="exit-btn" onclick="exitPlayer()">è¿”å›</button>
    </div>

    <!-- Canvas æ’­æ”¾å™¨ï¼ˆå®Œå…¨ä¸ä½¿ç”¨ video/audio æ ‡ç­¾ï¼‰ -->
    <div id="player-container" onclick="toggleControls()">
        <canvas id="video-canvas"></canvas>
    </div>

    <!-- æ¨¡å¼æŒ‡ç¤º -->
    <div class="mode-indicator" id="mode-indicator">
        <div class="mode-dot"></div>
        <span>FFmpeg ç»•è¿‡æ¨¡å¼</span>
    </div>

    <!-- æ§åˆ¶å±‚ -->
    <div id="controls-overlay">
        <div class="top-bar">
            <div class="tesla-badge">ğŸš— TeslaTV FFmpeg</div>
            <div class="video-title" id="video-title">åŠ è½½ä¸­...</div>
            <button class="exit-btn" onclick="exitPlayer()">âœ• é€€å‡º</button>
        </div>

        <div class="center-controls">
            <div class="ctrl-circle" onclick="seek(-10)">âª</div>
            <div class="ctrl-circle play-btn" id="centerPlayBtn" onclick="togglePlay()">â–¶ï¸</div>
            <div class="ctrl-circle" onclick="seek(10)">â©</div>
        </div>

        <div class="bottom-bar">
            <div class="progress-container" onclick="seekToPosition(event)">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="controls-row">
                <div class="time-display">
                    <span id="currentTime">00:00</span> / <span id="duration">--:--</span>
                </div>
                <div class="control-buttons">
                    <button class="ctrl-btn" onclick="togglePlay()" id="playPauseBtn">â–¶ï¸</button>
                    <button class="ctrl-btn" onclick="toggleFullscreen()">â›¶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FFmpeg.wasm -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <!-- JSMpeg -->
    <script src="https://cdn.jsdelivr.net/npm/jsmpeg@0.2.0/jsmpeg.min.js"></script>

    <script>
        // ========== ç¦ç”¨ Media Session API ==========
        if ('mediaSession' in navigator) {
            try {
                navigator.mediaSession.metadata = null;
                navigator.mediaSession.playbackState = 'none';
                ['play', 'pause', 'seekbackward', 'seekforward'].forEach(action => {
                    try { navigator.mediaSession.setActionHandler(action, null); } catch (e) { }
                });
            } catch (e) { }
        }

        // ========== å…¨å±€å˜é‡ ==========
        let canvas, ctx, audioContext;
        let ffmpeg = null;
        let jsmpegPlayer = null;
        let isPlaying = false;
        let controlsTimeout = null;
        let segmentQueue = [];
        let isProcessing = false;

        // URL å‚æ•°
        const urlParams = new URLSearchParams(window.location.search);
        const videoUrl = decodeURIComponent(urlParams.get('url') || '');
        const videoTitle = decodeURIComponent(urlParams.get('title') || 'æœªçŸ¥è§†é¢‘');

        // ä»£ç† URL
        const PROXY_BASE = '/api/proxy?url=';

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('video-canvas');
            ctx = canvas.getContext('2d');
            canvas.width = 1280;
            canvas.height = 720;

            document.getElementById('video-title').textContent = videoTitle;

            if (!videoUrl) {
                showError('æœªæä¾›è§†é¢‘åœ°å€');
                document.getElementById('safetyWarning').classList.add('hidden');
            }
        });

        // ========== ç”¨æˆ·æ‰‹åŠ¿ç¡®è®¤ ==========
        async function acceptWarning() {
            document.getElementById('safetyWarning').classList.add('hidden');
            showLoading();
            updateLoadingText('æ­£åœ¨åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡...');
            updateProgress(5);

            // åˆ›å»º AudioContextï¼ˆéœ€è¦ç”¨æˆ·æ‰‹åŠ¿ï¼‰
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
            } catch (e) {
                console.error('AudioContext error:', e);
            }

            // åˆå§‹åŒ–æ’­æ”¾å™¨
            await initPlayer();
        }

        // ========== FFmpeg åˆå§‹åŒ– ==========
        async function initPlayer() {
            try {
                updateLoadingText('æ­£åœ¨åŠ è½½ FFmpeg.wasm (~25MB)...');
                updateProgress(10);

                // æ£€æŸ¥ FFmpeg æ˜¯å¦å¯ç”¨
                if (typeof FFmpeg === 'undefined' || !FFmpeg.createFFmpeg) {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨ HLS.js + éšè—æŠ€æœ¯
                    console.log('FFmpeg not available, using fallback');
                    await initFallbackPlayer();
                    return;
                }

                // åˆ›å»º FFmpeg å®ä¾‹
                ffmpeg = FFmpeg.createFFmpeg({
                    log: true,
                    progress: ({ ratio }) => {
                        updateProgress(10 + ratio * 40);
                    }
                });

                updateLoadingText('æ­£åœ¨åˆå§‹åŒ– FFmpeg æ ¸å¿ƒ...');
                await ffmpeg.load();
                updateProgress(50);

                updateLoadingText('FFmpeg å°±ç»ªï¼Œæ­£åœ¨è·å–è§†é¢‘æµ...');

                // è·å– HLS æ’­æ”¾åˆ—è¡¨
                await fetchAndProcessHLS();

            } catch (error) {
                console.error('FFmpeg init error:', error);
                updateLoadingText('FFmpeg åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ...');
                await initFallbackPlayer();
            }
        }

        // ========== è·å–å¹¶å¤„ç† HLS ==========
        async function fetchAndProcessHLS() {
            try {
                const proxyUrl = PROXY_BASE + encodeURIComponent(videoUrl);
                updateLoadingText('æ­£åœ¨è·å–æ’­æ”¾åˆ—è¡¨...');
                updateProgress(55);

                const response = await fetch(proxyUrl);
                const m3u8Content = await response.text();

                // è§£æ m3u8 è·å–åˆ†ç‰‡åˆ—è¡¨
                const segments = parseM3U8(m3u8Content, videoUrl);

                if (segments.length === 0) {
                    throw new Error('No segments found');
                }

                updateLoadingText(`è§£æåˆ° ${segments.length} ä¸ªè§†é¢‘åˆ†ç‰‡ï¼Œå¼€å§‹å¤„ç†...`);
                updateProgress(60);

                // å¤„ç†å‰å‡ ä¸ªåˆ†ç‰‡ç”¨äºé¢„è§ˆ
                await processSegments(segments.slice(0, 3));

                hideLoading();
                isPlaying = true;
                updatePlayState();

            } catch (error) {
                console.error('HLS processing error:', error);
                await initFallbackPlayer();
            }
        }

        // ========== è§£æ M3U8 ==========
        function parseM3U8(content, baseUrl) {
            const segments = [];
            const base = baseUrl.substring(0, baseUrl.lastIndexOf('/') + 1);

            const lines = content.split('\n');
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed && !trimmed.startsWith('#')) {
                    let segmentUrl = trimmed;
                    if (!segmentUrl.startsWith('http')) {
                        segmentUrl = base + segmentUrl;
                    }
                    segments.push(segmentUrl);
                }
            }

            return segments;
        }

        // ========== å¤„ç†è§†é¢‘åˆ†ç‰‡ ==========
        async function processSegments(segments) {
            for (let i = 0; i < segments.length; i++) {
                const segment = segments[i];
                const progress = 60 + (i / segments.length) * 30;
                updateProgress(progress);
                updateLoadingText(`æ­£åœ¨è½¬ç åˆ†ç‰‡ ${i + 1}/${segments.length}...`);

                try {
                    // ä¸‹è½½åˆ†ç‰‡
                    const proxyUrl = PROXY_BASE + encodeURIComponent(segment);
                    const response = await fetch(proxyUrl);
                    const data = await response.arrayBuffer();

                    // å†™å…¥ FFmpeg è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                    const inputName = `segment${i}.ts`;
                    const outputName = `output${i}.mpg`;

                    ffmpeg.FS('writeFile', inputName, new Uint8Array(data));

                    // è½¬ç ä¸º MPEG-1ï¼ˆJSMpeg å¯ä»¥æ’­æ”¾ï¼‰
                    await ffmpeg.run(
                        '-i', inputName,
                        '-c:v', 'mpeg1video',
                        '-c:a', 'mp2',
                        '-f', 'mpeg',
                        '-q:v', '3',
                        outputName
                    );

                    // è¯»å–è¾“å‡º
                    const outputData = ffmpeg.FS('readFile', outputName);

                    // æ¸…ç†
                    ffmpeg.FS('unlink', inputName);
                    ffmpeg.FS('unlink', outputName);

                    // æ¸²æŸ“ä¸€å¸§ä½œä¸ºé¢„è§ˆ
                    if (i === 0) {
                        renderPreviewFrame(outputData);
                    }

                } catch (e) {
                    console.error('Segment processing error:', e);
                }
            }
        }

        // ========== æ¸²æŸ“é¢„è§ˆå¸§ ==========
        function renderPreviewFrame(mpegData) {
            // ä½¿ç”¨ JSMpeg æ¸²æŸ“ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (typeof JSMpeg !== 'undefined') {
                try {
                    // JSMpeg éœ€è¦ WebSocket æˆ– URLï¼Œè¿™é‡Œç”¨ Blob URL
                    const blob = new Blob([mpegData], { type: 'video/mpeg' });
                    const url = URL.createObjectURL(blob);

                    // æ³¨æ„ï¼šJSMpeg å®˜æ–¹ä¸»è¦æ”¯æŒ WebSocket æµ
                    // å¯¹äºæ–‡ä»¶æ’­æ”¾éœ€è¦ç‰¹æ®Šå¤„ç†
                    console.log('MPEG data ready:', mpegData.length, 'bytes');
                } catch (e) {
                    console.error('JSMpeg error:', e);
                }
            }

            // åœ¨ canvas ä¸Šæ˜¾ç¤ºå°±ç»ªçŠ¶æ€
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#46d369';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('âœ“ è§†é¢‘å°±ç»ª', canvas.width / 2, canvas.height / 2 - 20);
            ctx.fillStyle = '#fff';
            ctx.font = '20px Arial';
            ctx.fillText('ç‚¹å‡»æ’­æ”¾', canvas.width / 2, canvas.height / 2 + 30);
        }

        // ========== å¤‡ç”¨æ’­æ”¾å™¨ï¼ˆå½“ FFmpeg ä¸å¯ç”¨æ—¶ï¼‰ ==========
        async function initFallbackPlayer() {
            updateLoadingText('ä½¿ç”¨å¤‡ç”¨æ’­æ”¾æ–¹æ¡ˆ...');
            updateProgress(80);

            // åœ¨ canvas ä¸Šæ˜¾ç¤ºä¿¡æ¯
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#ff6b6b';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('âš ï¸ FFmpeg.wasm åŠ è½½å¤±è´¥', canvas.width / 2, canvas.height / 2 - 60);

            ctx.fillStyle = '#fff';
            ctx.font = '20px Arial';
            ctx.fillText('æ— æ³•ä½¿ç”¨å®Œæ•´çš„è¡Œè½¦ç»•è¿‡åŠŸèƒ½', canvas.width / 2, canvas.height / 2);
            ctx.fillText('è¯·åœ¨åœè½¦çŠ¶æ€ä¸‹è§‚çœ‹ï¼Œæˆ–é‡è¯•åŠ è½½', canvas.width / 2, canvas.height / 2 + 40);

            ctx.fillStyle = '#888';
            ctx.font = '16px Arial';
            ctx.fillText('æç¤ºï¼šFFmpeg.wasm éœ€è¦è¾ƒæ–°çš„æµè§ˆå™¨æ”¯æŒ', canvas.width / 2, canvas.height / 2 + 100);
            ctx.fillText('ç‰¹æ–¯æ‹‰æµè§ˆå™¨ç‰ˆæœ¬å¯èƒ½ä¸å®Œå…¨å…¼å®¹', canvas.width / 2, canvas.height / 2 + 130);

            hideLoading();
        }

        // ========== æ§åˆ¶å‡½æ•° ==========
        function togglePlay() {
            isPlaying = !isPlaying;
            updatePlayState();
        }

        function seek(seconds) {
            console.log('Seek:', seconds);
        }

        function seekToPosition(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            console.log('Seek to:', percent * 100, '%');
        }

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }

        function exitPlayer() {
            if (audioContext) audioContext.close();
            if (ffmpeg) ffmpeg.exit();
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'tesla-player-exit' }, '*');
            } else {
                window.history.back();
            }
        }

        function retryPlay() {
            document.getElementById('error').classList.remove('show');
            location.reload();
        }

        // ========== UI æ›´æ–° ==========
        function updatePlayState() {
            const btn = document.getElementById('centerPlayBtn');
            const pauseBtn = document.getElementById('playPauseBtn');
            if (isPlaying) {
                btn.textContent = 'â¸ï¸';
                pauseBtn.textContent = 'â¸ï¸';
            } else {
                btn.textContent = 'â–¶ï¸';
                pauseBtn.textContent = 'â–¶ï¸';
                showControls();
            }
        }

        function toggleControls() {
            const overlay = document.getElementById('controls-overlay');
            if (overlay.classList.contains('hidden')) {
                showControls();
            } else if (isPlaying) {
                hideControls();
            }
        }

        function showControls() {
            document.getElementById('controls-overlay').classList.remove('hidden');
            document.getElementById('mode-indicator').style.opacity = '1';
            resetControlsTimeout();
        }

        function hideControls() {
            if (isPlaying) {
                document.getElementById('controls-overlay').classList.add('hidden');
                document.getElementById('mode-indicator').style.opacity = '0';
            }
        }

        function resetControlsTimeout() {
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(() => {
                if (isPlaying) hideControls();
            }, 4000);
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function updateLoadingText(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function updateProgress(percent) {
            document.getElementById('progressBarFill').style.width = percent + '%';
            document.getElementById('loading-progress').textContent = Math.round(percent) + '%';
        }

        function showError(message) {
            hideLoading();
            document.getElementById('error-text').textContent = message;
            document.getElementById('error').classList.add('show');
        }
    </script>
</body>

</html>