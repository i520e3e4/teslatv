<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla AVPlayer</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #player-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: lime;
            font-family: monospace;
            z-index: 1000;
            pointer-events: none;
        }

        /* Custom Controls Overlay (Simplified) */
        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #player-container:hover #controls {
            opacity: 1;
        }

        button {
            background: none;
            border: 1px solid #fff;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            margin-right: 10px;
        }

        input[type="range"] {
            flex-grow: 1;
            margin: 0 10px;
        }

        #start-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        #startBtn {
            font-size: 24px;
            padding: 20px 40px;
            border: 2px solid #fff;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="player-container"></div>
    <div id="debug-info">Initializing...</div>
    <div id="controls">
        <button id="playBtn">Play</button>
        <input type="range" id="progressBar" value="0" min="0" max="100" step="0.1">
        <button id="fullScreenBtn">FS</button>
    </div>

    <div id="start-overlay">
        <button id="startBtn">Tap to Play</button>
    </div>

    <!-- Load Local libmedia AVPlayer (ES Module) -->
    <script type="module">
        import AVPlayer from './libs/js/libmedia.avplayer.min.js';

        const debugEl = document.getElementById('debug-info');
        function log(msg) {
            console.log(msg);
            const time = new Date().toLocaleTimeString();
            debugEl.innerHTML += `<br>[${time}] ${msg}`;
            const lines = debugEl.innerHTML.split('<br>');
            // Keep more lines for debugging
            if (lines.length > 15) debugEl.innerHTML = lines.slice(-15).join('<br>');
        }

        // Global Error Handlers
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            log(`Global Error: ${msg} at line ${lineNo}`);
            return false;
        };

        window.onunhandledrejection = function (event) {
            log(`Unhandled Rejection: ${event.reason}`);
        };

        // Network Check for valid files
        function checkFile(url) {
            return fetch(url, { method: 'HEAD' })
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.ok;
                })
                .catch(err => {
                    log(`File Check Failed: ${url} (${err.message})`);
                    return false;
                });
        }

        // 挂载到 window 方便调试
        window.AVPlayer = AVPlayer;

        const urlParams = new URLSearchParams(window.location.search);
        const videoUrl = urlParams.get('url');

        if (!videoUrl) {
            log('Error: No URL provided');
        } else {
            log('Target URL: ' + videoUrl);
            // 确保 DOM 加载完成
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => initPlayer(videoUrl));
            } else {
                initPlayer(videoUrl);
            }
        }

        // Environment Check
        function checkEnvironment() {
            log(`UA: ${navigator.userAgent}`);
            log(`Secure Context: ${window.isSecureContext}`);
            log(`Cross Origin Isolated: ${window.crossOriginIsolated}`);
            log(`SharedArrayBuffer: ${typeof SharedArrayBuffer !== 'undefined'}`);
        }

        function initPlayer(url) {
            log('Initializing AVPlayer...');
            checkEnvironment();

            const container = document.getElementById('player-container');

            const playerConfig = {
                container: container,
                isLive: url.indexOf('.m3u8') > -1,
                enableWorker: true,
                enableWebGPU: false,
                checkUseMES: () => false,
                getWasm: (type, codecId) => {
                    // Check availability first
                    const wasmBase = 'libs/wasm/';
                    let filename = '';
                    if (type === 'decoder') {
                        if (codecId === 27) filename = 'h264-atomic.wasm';
                        if (codecId === 86018) filename = 'aac-atomic.wasm';
                        if (codecId === 86017) filename = 'mp3-atomic.wasm';
                    }
                    if (type === 'resampler') filename = 'resample-atomic.wasm';
                    if (type === 'stretchpitcher') filename = 'stretchpitch-atomic.wasm';

                    if (filename) {
                        const fullPath = wasmBase + filename;
                        log(`Requesting WASM: ${filename}`);
                        return fullPath;
                    }
                    return '';
                }
            };

            // Pre-check main WASM files
            checkFile('libs/wasm/h264-atomic.wasm').then(ok => {
                if (ok) log('WASM h264 Check: OK');
            });

            try {
                const player = new AVPlayer(playerConfig);
                window.player = player;

                const initTimeout = setTimeout(() => {
                    log('WARNING: Player init timeout (10s). Ready event not fired.');
                }, 10000);

                player.on('ready', () => {
                    clearTimeout(initTimeout);
                    log('Player Ready');
                    player.loadSource(url);
                    attemptAutoPlay();
                });

                player.on('play', () => log('Event: Play'));
                player.on('pause', () => log('Event: Pause'));
                player.on('error', (e) => log('Error: ' + JSON.stringify(e)));
                player.on('timeupdate', (t) => {
                    const progress = (t / player.duration) * 100;
                    const pb = document.getElementById('progressBar');
                    if (pb) pb.value = progress;
                });

                // UI Bindings
                const playBtn = document.getElementById('playBtn');
                if (playBtn) {
                    playBtn.onclick = () => {
                        if (player.paused) player.play();
                        else player.pause();
                    };
                }

                const fsBtn = document.getElementById('fullScreenBtn');
                if (fsBtn) {
                    fsBtn.onclick = () => {
                        if (!document.fullscreenElement) {
                            container.requestFullscreen().catch(err => {
                                log(`FS Error: ${err.message}`);
                            });
                        } else {
                            document.exitFullscreen();
                        }
                    };
                }

                // Removed immediate player.play() call to avoid race condition

                function attemptAutoPlay() {
                    player.play().catch(e => {
                        log('Auto-play blocked');
                        // Show start overlay
                        const startOverlay = document.getElementById('start-overlay');
                        if (startOverlay) {
                            startOverlay.style.display = 'flex';
                            const startBtn = document.getElementById('startBtn');
                            startBtn.onclick = () => {
                                startOverlay.style.display = 'none'; // Hide immediately to prevent double clicks
                                player.play().then(() => {
                                    log('Playback started');
                                }).catch(err => {
                                    log('Play Error: ' + (err.message || JSON.stringify(err)));
                                    startOverlay.style.display = 'flex'; // Show again if failed
                                });
                            };
                        }
                    });
                }
            } catch (err) {
                log('Init Error: ' + err.message);
            }
        }
    </script>
</body>

</html>