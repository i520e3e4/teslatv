<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla AVPlayer (Jessibuca)</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #player-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        #debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: lime;
            font-family: monospace;
            z-index: 1000;
            pointer-events: none;
            text-shadow: 1px 1px 2px black;
        }

        /* Custom Controls Overlay */
        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #player-container:hover #controls {
            opacity: 1;
        }

        button {
            background: none;
            border: 1px solid #fff;
            color: #fff;
            padding: 5px 10px;
            cursor: pointer;
            margin-right: 10px;
        }

        input[type="range"] {
            flex-grow: 1;
            margin: 0 10px;
        }

        #start-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        #startBtn {
            font-size: 24px;
            padding: 20px 40px;
            border: 2px solid #fff;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
    <!-- Import Jessibuca -->
    <script src="./libs/jessibuca/jessibuca.js"></script>
</head>

<body>
    <div id="player-container"></div>
    <div id="debug-info">Initializing Jessibuca...</div>
    <div id="controls">
        <button id="playBtn">Play</button>
        <button id="muteBtn">Mute</button>
        <div style="color:white; margin-right:10px;" id="timeDisplay">00:00 / 00:00</div>
        <!-- Progress bar in live stream is often not useful, but keeping it for VOD -->
        <input type="range" id="progressBar" value="0" min="0" max="100" step="0.1">
        <button id="fullScreenBtn">FS</button>
        <button id="reloadBtn">Reload</button>
    </div>

    <div id="start-overlay">
        <button id="startBtn">Tap to Play</button>
    </div>

    <script>
        const debugEl = document.getElementById('debug-info');
        function log(msg) {
            console.log(msg);
            const time = new Date().toLocaleTimeString();
            debugEl.innerHTML += `<br>[${time}] ${msg}`;
            const lines = debugEl.innerHTML.split('<br>');
            if (lines.length > 15) debugEl.innerHTML = lines.slice(-15).join('<br>');
        }

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            log(`Global Error: ${msg} at line ${lineNo}`);
            return false;
        };

        const urlParams = new URLSearchParams(window.location.search);
        const videoUrl = urlParams.get('url');

        let jessibuca = null;

        function initPlayer() {
            if (!videoUrl) {
                log('Error: No URL provided');
                return;
            }

            log(`Target URL: ${videoUrl}`);
            const container = document.getElementById('player-container');

            // Force single-threaded mode / non-atomic WASM friendly settings if possible
            // Jessibuca generally handles correct WASM loading if decoder.js is correct.
            // In Tesla, SharedArrayBuffer is missing, so we rely on Jessibuca's fallback or single-thread mode.

            try {
                jessibuca = new Jessibuca({
                    container: container,
                    videoBuffer: 0.5,
                    decoder: './libs/jessibuca/decoder.js', // Explicitly point to our local decoder
                    isResize: false,
                    loadingText: 'Loading...',
                    hasAudio: true,
                    debug: true,
                    supportDblclickFullscreen: true,
                    showBandwidth: true, // Show network speed
                    operateBtns: {
                        fullscreen: false, // We use custom buttons
                        screenshot: false,
                        play: false,
                        audio: false,
                    },
                    forceNoOffscreen: true, // Critical for environments with strict DOM/Worker isolation or no OffscreenCanvas
                    isNotMute: false, // Start muted to help autoplay, user can unmute
                });

                window.player = jessibuca; // Expose for debugging

                // Event Listeners
                jessibuca.on('load', () => log('Event: Loading...'));
                jessibuca.on('timeUpdate', (ts) => {
                    // ts is usually current timestamp
                    // Update UI if needed. For live streams, duration might be infinite.
                });
                jessibuca.on('videoInfo', (info) => {
                    log(`Video Info: ${info.width}x${info.height}`);
                });
                jessibuca.on('error', (error) => {
                    log('Jessibuca Error: ' + JSON.stringify(error));
                });
                jessibuca.on('timeout', () => {
                    log('Event: Timeout');
                });
                jessibuca.on('start', () => {
                    log('Event: Start Playback');
                    document.getElementById('start-overlay').style.display = 'none';
                    updatePlayBtnState(true);
                });
                jessibuca.on('pause', () => {
                    log('Event: Pause');
                    updatePlayBtnState(false);
                });
                jessibuca.on('play', () => {
                    log('Event: Play');
                    updatePlayBtnState(true);
                });

                // Play
                jessibuca.play(videoUrl).then(() => {
                    log('Play request success');
                }).catch(e => {
                    log('Play failed: ' + e.message);
                    document.getElementById('start-overlay').style.display = 'flex';
                });

            } catch (err) {
                log('Init Exception: ' + err.message);
            }
        }

        // UI Controls
        const playBtn = document.getElementById('playBtn');
        const muteBtn = document.getElementById('muteBtn');
        const fsBtn = document.getElementById('fullScreenBtn');
        const reloadBtn = document.getElementById('reloadBtn');
        const startBtn = document.getElementById('startBtn');

        function updatePlayBtnState(playing) {
            if (playing) {
                playBtn.innerText = "Pause";
            } else {
                playBtn.innerText = "Play";
            }
        }

        playBtn.onclick = () => {
            if (jessibuca) {
                // We rely on the button text or internal state inferred from events
                if (playBtn.innerText === "Pause") {
                    jessibuca.pause();
                } else {
                    jessibuca.play(videoUrl); // or jessibuca.play() if already loaded?
                }
            }
        };

        muteBtn.onclick = () => {
            if (jessibuca) {
                if (jessibuca.isMute()) {
                    jessibuca.mute(false);
                    muteBtn.innerText = "Mute";
                } else {
                    jessibuca.mute(true);
                    muteBtn.innerText = "Unmute";
                }
            }
        };

        fsBtn.onclick = () => {
            if (jessibuca) {
                jessibuca.setFullscreen(!jessibuca.isFullscreen());
            }
        };

        reloadBtn.onclick = () => {
            if (jessibuca) {
                jessibuca.destroy();
                setTimeout(initPlayer, 500);
            } else {
                window.location.reload();
            }
        }

        startBtn.onclick = () => {
            document.getElementById('start-overlay').style.display = 'none';
            if (jessibuca) {
                jessibuca.play(videoUrl).catch(e => log('Manual play err: ' + e.message));
            } else {
                initPlayer();
            }
        };

        // Start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPlayer);
        } else {
            initPlayer();
        }

    </script>
</body>

</html>